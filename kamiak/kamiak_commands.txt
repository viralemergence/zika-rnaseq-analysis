# To run on Kamiak with Singularity
module load singularity
mkdir ./src/singularity_image
singularity pull ./src/singularity_image/zika.sif docker://alexanderbrown1313/zika:latest

# Command prep
SINGULARITY_IMAGE="/home/alexander.brown/zika-rnaseq-analysis/src/singularity_image/zika.sif"
MAKEFILE="/src/container_commands/Makefile"

HOST_APP_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/app"
HOST_DATA_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/data"
HOST_DATA_STAR_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/data/star"
HOST_DATA_GENE_COUNT_PROCESSING_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/data/gene_count_processing"
HOST_DATA_BATCH_EFFECT_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/data/batch_effect_rectified"
HOST_DATA_DESEQ_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/data/pydeseq2"
HOST_DATA_GO_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/data/go_analysis"
HOST_GENOME_DIR="/home/alexander.brown/zika-rnaseq-analysis/src/genomes"

R1_ADAPTER_SEQ="AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC"
R2_ADAPTER_SEQ="AGATCGGAAGAGCGTCGTGTAGGGAAAGA"

SCRATCH_DIR="/scratch/user/alexander.brown/20241028_213454"
FASTQ_DIR=$SCRATCH_DIR"/fastq"
PROCESSED_FASTQ_DIR=$SCRATCH_DIR"/processed_fastq"
FASTQC_DIR=$SCRATCH_DIR"/fastqc"
STAR_RESULTS_DIR=$SCRATCH_DIR"/star"

# To download fastq.gz data via Singularity
singularity exec --pwd /src \
    --no-home \
    --bind $FASTQ_DIR:/src/data/fastq \
    --bind /etc:/etc \
    --env-file `pwd`/.env \
    $SINGULARITY_IMAGE \
    bs download project -i 432190937 -o /src/data/fastq --extension=fastq.gz
# Also: 423121844

# To process fastq.gz data with fastp
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $FASTQ_DIR:/src/data/fastq \
    --bind $PROCESSED_FASTQ_DIR:/src/data/processed_fastq \
    ./src/singularity_image/zika.sif \
    python3 -u /src/app/fastp_orchestration.py \
    -i /src/data/fastq -o /src/data/processed_fastq -j 1 \
    -r1a $R1_ADAPTER_SEQ -r2a $R2_ADAPTER_SEQ

# To QC fastq.gz data with fastqc
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $PROCESSED_FASTQ_DIR:/src/data/processed_fastq \
    --bind $FASTQC_DIR:/src/data/fastqc \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/fastqc_orchestration.py \
    -i /src/data/processed_fastq -o /src/data/fastqc -j 1

# Downloading Rousettus data
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/014/176/215/GCF_014176215.1_mRouAeg1.p/GCF_014176215.1_mRouAeg1.p_genomic.fna.gz \
    -P ./src/genomes \
    && gzip -d ./src/genomes/GCF_014176215.1_mRouAeg1.p_genomic.fna.gz
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/014/176/215/GCF_014176215.1_mRouAeg1.p/GCF_014176215.1_mRouAeg1.p_genomic.gtf.gz \
    -P ./src/genomes \
    && gzip -d ./src/genomes/GCF_014176215.1_mRouAeg1.p_genomic.gtf.gz

# To generate STAR genome index; ~15 min
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_GENOME_DIR:/src/genomes \
    $SINGULARITY_IMAGE \
    STAR \
    --runThreadN 10 --runMode genomeGenerate \
    --genomeDir /src/genomes/rousettus_star_index/ \
    --genomeFastaFiles /src/genomes/GCF_014176215.1_mRouAeg1.p_genomic.fna \
    --sjdbGTFfile /src/genomes/GCF_014176215.1_mRouAeg1.p_genomic.gtf --sjdbOverhang 100 \
    --outFileNamePrefix /src/genomes/rousettus_star_index/

# To generate gene counts with STAR
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_GENOME_DIR:/src/genomes \
    --bind $PROCESSED_FASTQ_DIR:/src/data/processed_fastq \
    --bind $STAR_RESULTS_DIR:/src/data/star_results \
    --bind $HOST_DATA_STAR_DIR:/src/data/star \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/star_orchestration.py \
    -i /src/data/processed_fastq -f /src/data/star/sample_file_names.txt -o /src/data/star_results -j 0

# Downloading Artibeus data
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/021/234/435/GCF_021234435.1_CSHL_Jam_final/GCF_021234435.1_CSHL_Jam_final_genomic.fna.gz \
    -P ./src/genomes \
    && gzip -d ./src/genomes/GCF_021234435.1_CSHL_Jam_final_genomic.fna.gz
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/021/234/435/GCF_021234435.1_CSHL_Jam_final/GCF_021234435.1_CSHL_Jam_final_genomic.gtf.gz \
    -P ./src/genomes \
    && gzip -d ./src/genomes/GCF_021234435.1_CSHL_Jam_final_genomic.gtf.gz

# To generate STAR genome index; ~X min
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_GENOME_DIR:/src/genomes \
    $SINGULARITY_IMAGE \
    STAR \
    --runThreadN 10 --runMode genomeGenerate \
    --genomeDir /src/genomes/artibeus_star_index/ \
    --genomeFastaFiles /src/genomes/GCF_021234435.1_CSHL_Jam_final_genomic.fna \
    --sjdbGTFfile /src/genomes/GCF_021234435.1_CSHL_Jam_final_genomic.gtf --sjdbOverhang 100 \
    --outFileNamePrefix /src/genomes/artibeus_star_index/

# To generate gene counts with STAR
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_GENOME_DIR:/src/genomes \
    --bind $PROCESSED_FASTQ_DIR:/src/data/processed_fastq \
    --bind $STAR_RESULTS_DIR:/src/data/star_results \
    --bind $HOST_DATA_STAR_DIR:/src/data/star \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/star_orchestration.py \
    -i /src/data/processed_fastq -f /src/data/star/sample_file_names_new_world.txt \
    -g /src/genomes/artibeus_star_index -o /src/data/star_results -j 0

# To collate STAR gene counts, preprocess sample metadata, and preprocess gene counts
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_STAR_DIR:/src/data/star \
    --bind $HOST_DATA_GENE_COUNT_PROCESSING_DIR:/src/data/gene_count_processing \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/gene_count_and_metadata_processing.py \
    -i /src/data/star/gene_counts \
    -c /src/data/gene_count_processing/collated_gene_counts.csv \
    -m /src/data/gene_count_processing/sample_metadata.csv \
    -k /src/data/gene_count_processing/samples_to_combine.csv

# To run correct batch effect with pycombat
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_GENE_COUNT_PROCESSING_DIR:/src/data/gene_count_processing \
    --bind $HOST_DATA_BATCH_EFFECT_DIR:/src/data/batch_effect_rectified \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/batch_effect_rectification.py \
    -c /src/data/gene_count_processing/processed_gene_counts.csv \
    -m /src/data/gene_count_processing/processed_sample_metadata.csv \
    -o /src/data/batch_effect_rectified

# To run PyDeseq2
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DESEQ_DIR:/src/data/pydeseq2 \
    --bind $HOST_DATA_BATCH_EFFECT_DIR:/src/data/batch_effect_rectified \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/differential_expression_analysis.py \
    -c /src/data/batch_effect_rectified/gene_counts_final.csv \
    -m /src/data/batch_effect_rectified/sample_metadata_final.csv

# To test R Deseq2 LRT function
singularity exec --pwd /src \
    --no-home \
    --env LC_ALL=C.UTF-8 \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DESEQ_DIR:/src/data/pydeseq2 \
    $SINGULARITY_IMAGE \
    Rscript /src/app/log_ratio_test.R \
    "/src/data/pydeseq2/lrt/gene_counts_R_input.csv" \
    "/src/data/pydeseq2/lrt/sample_metadata_R_input.csv" \
    "/src/data/pydeseq2/lrt/LRT_results.csv"

# To test R degpattern function
singularity exec --pwd /src \
    --no-home \
    --env LC_ALL=C.UTF-8 \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DESEQ_DIR:/src/data/pydeseq2 \
    $SINGULARITY_IMAGE \
    Rscript /src/app/degpattern_clustering.R \
    "/src/data/pydeseq2/degpattern/gene_counts_degpattern_input.csv" \
    "/src/data/pydeseq2/degpattern/sample_metadata_degpattern_input.csv" \
    "/src/data/pydeseq2/degpattern/gene_clusters.csv"

# To test goatools
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DESEQ_DIR:/src/data/pydeseq2 \
    --bind $HOST_DATA_GO_DIR:/src/data/go_analysis \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/goatools_chiroptera.py \
    -t 9407 -g 12 \
    -b "/src/data/go_analysis/ncbi_gene_results_9407.txt" \
    -s "/src/data/pydeseq2/degpatterns/R06E_MR_gene_clusters.csv"

# To test gomcl with public test data
wget https://github.com/Guannan-Wang/GOMCL/raw/refs/heads/master/tests/Wendrich_PNAS_SD2_LR_TMO5_H_vs_L.bgo \
    -O $HOST_DATA_GO_DIR/Wendrich_PNAS_SD2_LR_TMO5_H_vs_L.bgo

singularity exec --pwd /src \
    --no-home \
    --bind $HOST_DATA_GO_DIR:/src/data/go_analysis \
    $SINGULARITY_IMAGE \
    GOMCL.py \
    /src/data/go_analysis/go-basic.obo \
    /src/data/go_analysis/Wendrich_PNAS_SD2_LR_TMO5_H_vs_L.bgo \
    -gotype BP CC MF

# To test gomcl
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_DATA_GO_DIR:/src/data/go_analysis \
    $SINGULARITY_IMAGE \
    GOMCL.py \
    /src/data/go_analysis/go-basic.obo \
    /src/data/go_analysis/goatools_results.txt \
    -gotype BP CC MF \
    -gosize 3000 \
    -got generic \
    -hm -nw \
    -SI OC -Ct .5 -I 2

# To run PyDeseq2 for Genes of Interest
singularity exec --pwd /src \
    --no-home \
    --bind $HOST_APP_DIR:/src/app \
    --bind $HOST_DATA_DESEQ_DIR:/src/data/pydeseq2 \
    --bind $HOST_DATA_BATCH_EFFECT_DIR:/src/data/batch_effect_rectified \
    $SINGULARITY_IMAGE \
    python3 -u /src/app/dea_goi.py \
    -c /src/data/batch_effect_rectified/gene_counts_final.csv \
    -m /src/data/batch_effect_rectified/sample_metadata_final.csv \
    -g /src/data/pydeseq2/goi/goi_list.csv